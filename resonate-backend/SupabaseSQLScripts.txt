-- 1. Create the Cleanup Function
create or replace function delete_file_when_entry_deleted()
returns trigger
language plpgsql
security definer
as $$
begin
  if OLD.audio_path is not null then
      delete from storage.objects
      where bucket_id = 'audio-recordings' 
      and name = OLD.audio_path;
  end if;

  return OLD;
end;
$$;

-- 2. Create the Trigger on the TABLE
drop trigger if exists on_entry_delete_cleanup on public."DiaryEntry";

create trigger on_entry_delete_cleanup
after delete on public."DiaryEntry"
for each row
execute function delete_file_when_entry_deleted();



-- Function to handle UPDATE (e.g., removing audio but keeping text)
create or replace function delete_file_on_unlink()
returns trigger
language plpgsql
security definer
as $$
begin
  -- If audio_path changed from "Something" to "NULL", delete the old file
  if OLD.audio_path is not null and NEW.audio_path is null then
      delete from storage.objects
      where bucket_id = 'audio-recordings' 
      and name = OLD.audio_path;
  end if;
  return NEW;
end;
$$;

-- Trigger for UPDATES
drop trigger if exists on_audio_unlink on public."DiaryEntry";

create trigger on_audio_unlink
after update on public."DiaryEntry"
for each row
execute function delete_file_on_unlink();


